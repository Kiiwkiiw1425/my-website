<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DPIS6 Monitoring Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-7xl mx-auto">
    <h1 class="text-3xl font-bold mb-4">DPIS6 Monitoring Dashboard</h1>

    <!-- Filters -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
      <select id="ministryFilter" class="p-2 rounded border border-gray-300">
        <option value="">-- เลือกกระทรวง --</option>
      </select>
      <select id="statusFilter" class="p-2 rounded border border-gray-300">
        <option value="">-- เลือกสถานะ --</option>
      </select>
      <select id="locationFilter" class="p-2 rounded border border-gray-300">
        <option value="">-- เลือกจังหวัด --</option>
      </select>
      <select id="setupFilter" class="p-2 rounded border border-gray-300">
        <option value="">-- เลือกลักษณะการติดตั้ง --</option>
      </select>
      <select id="affiliationFilter" class="p-2 rounded border border-gray-300">
        <option value="">-- เลือกสังกัด --</option>
      </select>
      <select id="usageStatusFilter" class="p-2 rounded border border-gray-300">
        <option value="">-- เลือกสถานะการใช้งาน --</option>
      </select>
      <input type="text" id="searchInput" placeholder="ค้นหา..." class="p-2 rounded border border-gray-300 col-span-1 sm:col-span-3" />
    </div>

    <!-- Data Container -->
    <div id="dataContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    <div id="noDataMsg" class="text-center text-gray-500 mt-4 hidden">ไม่พบข้อมูล</div>
  </div>

  <script>
    const sheetURL = "https://docs.google.com/spreadsheets/d/1b8JrOkDDE3zvuDAtS9JtQvlYzp9A7NU4aFzyrlp3XXg/gviz/tq?tqx=out:json";

    let allData = [];

    const $ = (id) => document.getElementById(id);

    const renderData = (data) => {
      const container = $("dataContainer");
      container.innerHTML = "";

      if (data.length === 0) {
        $("noDataMsg").classList.remove("hidden");
        return;
      } else {
        $("noDataMsg").classList.add("hidden");
      }

      data.forEach(item => {
        const card = document.createElement("div");
        card.className = "bg-white rounded-xl shadow p-4";
        card.innerHTML = `
          <h2 class="font-bold text-lg">${item.department}</h2>
          <p><strong>กระทรวง:</strong> ${item.ministry}</p>
          <p><strong>สถานะ:</strong> ${item.status}</p>
          <p><strong>ติดตั้ง:</strong> ${item.setup}</p>
          <p><strong>จังหวัด:</strong> ${item.location}</p>
          <p><strong>สังกัด:</strong> ${item.affiliation}</p>
          <p><strong>การใช้งาน:</strong> ${item.usage}</p>
        `;
        container.appendChild(card);
      });
    };

    const filterData = () => {
      const ministry = $("ministryFilter").value;
      const status = $("statusFilter").value;
      const location = $("locationFilter").value;
      const setup = $("setupFilter").value;
      const affiliation = $("affiliationFilter").value;
      const usage = $("usageStatusFilter").value;
      const keyword = $("searchInput").value.toLowerCase();

      const filtered = allData.filter(item =>
        (!ministry || item.ministry === ministry) &&
        (!status || item.status === status) &&
        (!location || item.location === location) &&
        (!setup || item.setup === setup) &&
        (!affiliation || item.affiliation === affiliation) &&
        (!usage || item.usage === usage) &&
        (
          item.ministry.toLowerCase().includes(keyword) ||
          item.department.toLowerCase().includes(keyword) ||
          item.status.toLowerCase().includes(keyword) ||
          item.setup.toLowerCase().includes(keyword) ||
          item.location.toLowerCase().includes(keyword) ||
          item.affiliation.toLowerCase().includes(keyword) ||
          item.usage.toLowerCase().includes(keyword)
        )
      );

      renderData(filtered);
    };

    const populateSelect = (id, options) => {
      const select = $(id);
      options.forEach(opt => {
        const option = document.createElement("option");
        option.value = opt;
        option.textContent = opt;
        select.appendChild(option);
      });
    };

    const populateFilters = (data) => {
      const uniqueValues = (key) => [...new Set(data.map(item => item[key]).filter(Boolean))].sort();

      populateSelect("ministryFilter", uniqueValues("ministry"));
      populateSelect("statusFilter", uniqueValues("status"));
      populateSelect("locationFilter", uniqueValues("location"));
      populateSelect("setupFilter", uniqueValues("setup"));
      populateSelect("affiliationFilter", uniqueValues("affiliation"));
      populateSelect("usageStatusFilter", uniqueValues("usage"));
    };

    const fetchData = async () => {
      try {
        const res = await fetch(sheetURL);
        const text = await res.text();
        const json = JSON.parse(text.substr(47).slice(0, -2));
        const rows = json.table.rows;

        allData = rows.map(row => ({
          ministry: row.c[0]?.v || "",
          department: row.c[1]?.v || "",
          status: row.c[2]?.v || "",
          setup: row.c[3]?.v || "",
          location: row.c[4]?.v || "",
          affiliation: row.c[5]?.v || "",
          usage: row.c[6]?.v || ""
        }));

        renderData(allData);
        populateFilters(allData);
      } catch (err) {
        console.error("Error loading data:", err);
        $("noDataMsg").classList.remove("hidden");
      }
    };

    ["ministryFilter", "statusFilter", "locationFilter", "setupFilter", "affiliationFilter", "usageStatusFilter"]
      .forEach(id => $(id).addEventListener("change", filterData));
    $("searchInput").addEventListener("input", filterData);

    window.onload = fetchData;
  </script>
</body>
</html>
