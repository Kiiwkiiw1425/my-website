<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Monitor</title>
    <script>
        let allPosts = [];
        let latestUpdatePost = null;

        async function fetchData() {
            const sheetURL = "YOUR_GOOGLE_SHEET_URL";
            try {
                const response = await fetch(sheetURL);
                const data = await response.json();
                
                allPosts = data.map(row => ({
                    date: row[0], // วันที่
                    title: row[1], // หัวข้อ
                    detail: row[2], // รายละเอียด
                    category: row[3], // หมวดหมู่
                    month: row[4] // เดือน
                })).filter(post => post.detail); // กรองเฉพาะที่มีข้อมูลในคอลัมน์ C

                latestUpdatePost = allPosts.find(p => !!p.detail); // รายการแรกที่มีรายละเอียด ถือเป็นอัปเดตล่าสุด

                renderPosts(allPosts);
            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }

        function applyFilters() {
            const search = document.getElementById("searchInput").value.toLowerCase();
            const start = document.getElementById("startDate").value;
            const end = document.getElementById("endDate").value;
            const monthVal = document.getElementById("monthFilter").value;
            const catVal = document.getElementById("categoryFilter").value;
            const status = document.getElementById("statusFilter").value;

            let filtered = allPosts.filter(post => {
                const postDate = new Date(post.date);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                if (!post.detail || postDate > today) return false; // ✅ เฉพาะรายการที่มีรายละเอียด และไม่เกินวันนี้

                let match = true;
                if (search && !`${post.title} ${post.detail}`.toLowerCase().includes(search)) match = false;
                if (start && postDate < new Date(start)) match = false;
                if (end && postDate > new Date(end)) match = false;
                if (monthVal && post.month !== monthVal) match = false;
                if (catVal && post.category !== catVal) match = false;

                // ✅ ตัวกรองสถานะ
                if (status === "hasUpdate" && !post.detail) match = false;
                if (status === "noUpdate" && post.detail) match = false;
                if (status === "latestUpdate" && post !== latestUpdatePost) match = false;

                return match;
            });

            document.getElementById("statusCount").textContent = `${filtered.length} รายการ`;
            renderPosts(filtered);
        }

        function renderPosts(posts) {
            const container = document.getElementById("postContainer");
            container.innerHTML = posts.map(post => `
                <div class="post">
                    <h3>${post.title}</h3>
                    <p>${post.detail}</p>
                    <span>${post.date}</span>
                </div>
            `).join("");
        }

        window.onload = fetchData;
    </script>
</head>
<body>
    <div>
        <input type="text" id="searchInput" placeholder="ค้นหา..." onkeyup="applyFilters()">
        <input type="date" id="startDate" onchange="applyFilters()">
        <input type="date" id="endDate" onchange="applyFilters()">
        
        <select id="monthFilter" onchange="applyFilters()">
            <option value="">ทุกเดือน</option>
            <option value="1">มกราคม</option>
            <option value="2">กุมภาพันธ์</option>
            <!-- เพิ่มเดือนอื่นๆ -->
        </select>

        <select id="categoryFilter" onchange="applyFilters()">
            <option value="">ทุกหมวดหมู่</option>
            <option value="news">ข่าวสาร</option>
            <option value="update">อัปเดต</option>
            <!-- เพิ่มหมวดหมู่อื่นๆ -->
        </select>

        <label>สถานะอัปเดต <span id="statusCount"></span></label>
        <select id="statusFilter" onchange="applyFilters()">
            <option value="">ทั้งหมด</option>
            <option value="hasUpdate">เฉพาะวันที่มีอัปเดต</option>
            <option value="noUpdate">เฉพาะวันที่ไม่มีอัปเดต</option>
            <option value="latestUpdate">อัปเดตล่าสุด</option>
        </select>
    </div>

    <div id="postContainer"></div>
</body>
</html>
