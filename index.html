<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>อัปเดตโปรแกรม</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    label { margin-right: 10px; }
    input[type="date"] { margin-right: 10px; }
    button { margin-right: 10px; }
  </style>
  <script type="text/javascript">
    google.charts.load('current', { packages: ['table'] });
    google.charts.setOnLoadCallback(drawTable);

    let originalData;
    let table;

    function drawTable() {
      const queryString = encodeURIComponent('SELECT A, B, C ORDER BY A DESC');
      const query = new google.visualization.Query('https://docs.google.com/spreadsheets/d/1xRqnFHRWL3l_-6-LNJ_LM5Bejiv0aV5JwcV9PtzC-Nk/gviz/tq?sheet=Sheet1&tq=' + queryString);

      query.send(function (response) {
        if (response.isError()) {
          console.error('Error: ' + response.getMessage() + ' ' + response.getDetailedMessage());
          return;
        }

        originalData = response.getDataTable();
        table = new google.visualization.Table(document.getElementById('table_div'));
        table.draw(originalData, { showRowNumber: false, width: '100%' });
      });
    }

    function toDateObjFromBE(dateStr) {
      const [y, m, d] = dateStr.split('-').map(Number);
      return new Date(y - 543, m - 1, d); // แปลงจาก พ.ศ. เป็น ค.ศ.
    }

    function filterData() {
      const start = document.getElementById('start_date').value;
      const end = document.getElementById('end_date').value;

      if (!start || !end) return;

      const startDate = toDateObjFromBE(start);
      const endDate = toDateObjFromBE(end);

      const filteredData = new google.visualization.DataTable();
      filteredData.addColumn('string', 'วันที่อัปเดต');
      filteredData.addColumn('string', 'ชื่อโพสต์');
      filteredData.addColumn('string', 'รายละเอียด');

      for (let i = 0; i < originalData.getNumberOfRows(); i++) {
        const dateText = originalData.getValue(i, 0);
        const dateObj = new Date(dateText); // ค.ศ.

        // ถ้าอยู่ในช่วงที่เลือก
        if (dateObj >= startDate && dateObj <= endDate) {
          filteredData.addRow([
            originalData.getValue(i, 0),
            originalData.getValue(i, 1),
            originalData.getValue(i, 2),
          ]);
        }
      }

      table.draw(filteredData, { showRowNumber: false, width: '100%' });
    }

    function resetFilter() {
      document.getElementById('start_date').value = '';
      document.getElementById('end_date').value = '';
      table.draw(originalData, { showRowNumber: false, width: '100%' });
    }
  </script>
</head>
<body>
  <h2>อัปเดตโปรแกรมประจำวัน</h2>

  <div>
    <label for="start_date">เริ่มต้นวันที่ (พ.ศ.):</label>
    <input type="date" id="start_date" />
    <label for="end_date">ถึงวันที่ (พ.ศ.):</label>
    <input type="date" id="end_date" />
    <button onclick="filterData()">กรองข้อมูล</button>
    <button onclick="resetFilter()">ล้างตัวกรอง</button>
  </div>

  <br />
  <div id="table_div"></div>
</body>
</html>
