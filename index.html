<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DPIS Updates</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800 p-4">
  <div class="max-w-7xl mx-auto">
    <h1 class="text-2xl font-bold mb-4">รายการอัปเดต <span id="totalCount" class="text-blue-600">(0)</span></h1>

    <!-- Filters -->
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-4">
      <input id="searchInput" type="text" placeholder="ค้นหา..." class="border rounded px-3 py-2 w-full" />
      <input id="startDate" type="date" class="border rounded px-3 py-2 w-full" />
      <input id="endDate" type="date" class="border rounded px-3 py-2 w-full" />
      <select id="monthFilter" class="border rounded px-3 py-2 w-full">
        <option value="">ทุกเดือน</option>
      </select>
      <select id="updateStatus" class="border rounded px-3 py-2 w-full">
        <option value="hasUpdate">วันที่มีการอัปเดต</option>
        <option value="noUpdate">วันที่ไม่มีการอัปเดต</option>
        <option value="">แสดงทั้งหมด</option>
      </select>
    </div>

    <!-- Buttons -->
    <div class="flex flex-wrap gap-2 mb-4">
      <button onclick="resetFilters()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold px-4 py-2 rounded">ล้าง</button>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto">
      <table class="min-w-full table-auto border border-gray-300 bg-white">
        <thead class="bg-gray-200">
          <tr>
            <th class="px-4 py-2 border">วันที่</th>
            <th class="px-4 py-2 border">หัวข้อ</th>
            <th class="px-4 py-2 border">รายละเอียด</th>
            <th class="px-4 py-2 border">หมวดหมู่</th>
          </tr>
        </thead>
        <tbody id="updatesTable"></tbody>
      </table>
    </div>

    <div id="loadingMessage" class="text-center text-gray-500 mt-4">กำลังโหลดข้อมูล...</div>
  </div>

  <script>
    const $ = id => document.getElementById(id);
    const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTwBLrgrHQ_Pp9J10Zg_sYiH0MQBy8CI8Dd3EZJxFu05DxFBlHRgfdrdS3MG-MAJ6GVcGHbHfeLGG93/pub?output=tsv&headers=1&single=true&output=csv&alt=json";

    let allPosts = [];

    const thaiMonths = [
      "มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน",
      "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"
    ];

    const parseThaiDate = (dateStr) => {
      const parts = dateStr.split(" ");
      if (parts.length < 3) return new Date("Invalid");
      const day = parseInt(parts[0]);
      const month = thaiMonths.indexOf(parts[1]);
      const year = parseInt(parts[2]) - 543;
      return new Date(year, month, day);
    };

    const extractMonth = (dateStr) => {
      const parts = dateStr.split(" ");
      return parts[1] || "";
    };

    const getCurrentMonth = () => {
      const now = new Date();
      return thaiMonths[now.getMonth()];
    };

    const fillDropdowns = () => {
      const monthSet = new Set(allPosts.map(post => post.month));
      const sortedMonths = thaiMonths.filter(month => monthSet.has(month));
      const monthDropdown = $("monthFilter");

      sortedMonths.forEach(month => {
        const opt = document.createElement("option");
        opt.value = month;
        opt.textContent = month;
        monthDropdown.appendChild(opt);
      });
    };

    const applyFilters = () => {
      const keyword = $("searchInput").value.toLowerCase();
      const start = $("startDate").value ? new Date($("startDate").value) : null;
      const end = $("endDate").value ? new Date($("endDate").value) : null;
      const month = $("monthFilter").value;
      const status = $("updateStatus").value;

      let filtered = allPosts.filter(post => {
        const matchesKeyword =
          post.title.toLowerCase().includes(keyword) ||
          post.detail.toLowerCase().includes(keyword);

        const postDate = post.sortDate;
        const inRange = (!start || postDate >= start) && (!end || postDate <= end);
        const inMonth = !month || post.month === month;
        const statusMatch =
          status === "hasUpdate" ? post.detail.trim() !== "" :
          status === "noUpdate" ? post.detail.trim() === "" :
          true;

        return matchesKeyword && inRange && inMonth && statusMatch;
      });

      renderTable(filtered);
    };

    const renderTable = (posts) => {
      const table = $("updatesTable");
      table.innerHTML = "";
      $("totalCount").textContent = `(${posts.length})`;

      posts.forEach(post => {
        const row = document.createElement("tr");

        ["date", "title", "detail", "category"].forEach(key => {
          const cell = document.createElement("td");
          cell.textContent = post[key];
          cell.className = "border px-4 py-2 align-top";
          row.appendChild(cell);
        });

        table.appendChild(row);
      });
    };

    const resetFilters = () => {
      $("searchInput").value = "";
      $("startDate").value = "";
      $("endDate").value = "";
      $("monthFilter").value = getCurrentMonth();
      $("updateStatus").value = "hasUpdate";
      applyFilters();
    };

    fetch(sheetURL)
      .then(res => res.text())
      .then(text => {
        const json = JSON.parse(text.substring(47).slice(0, -2));
        allPosts = json.table.rows.map(row => {
          const date = row.c[0]?.f || row.c[0]?.v || "";
          return {
            date,
            title: row.c[1]?.v || "",
            detail: row.c[2]?.v || "",
            category: row.c[3]?.v || "",
            month: extractMonth(date),
            sortDate: parseThaiDate(date)
          };
        }).sort((a, b) => b.sortDate - a.sortDate);

        fillDropdowns();
        $("updateStatus").value = "hasUpdate";
        $("monthFilter").value = getCurrentMonth();
        applyFilters();
        $("loadingMessage").style.display = "none";
      });

    ["searchInput", "startDate", "endDate", "monthFilter", "updateStatus"].forEach(id => {
      $(id).addEventListener("input", applyFilters);
    });
  </script>
</body>
</html>
