<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üì¢ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏∞‡∏ö‡∏ö DPIS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .resizable { position: relative; user-select: none; overflow: hidden; }
    .resizable .resizer { position: absolute; top: 0; right: 0; width: 5px; height: 100%; cursor: ew-resize; background-color: #ddd; }
    th, td { white-space: nowrap; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 p-4">
  <div class="max-w-6xl mx-auto">
    <h2 class="text-3xl font-semibold mb-6 text-left text-blue-600">üì¢ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏∞‡∏ö‡∏ö DPIS</h2>

    <!-- Filters Section -->
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-6">
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-1">‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
        <input id="searchInput" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥..." class="w-full border border-gray-300 rounded-lg px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"/>
      </div>
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
        <input id="startDate" type="date" class="w-full border border-gray-300 rounded-lg px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"/>
      </div>
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
        <input id="endDate" type="date" class="w-full border border-gray-300 rounded-lg px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"/>
      </div>
      <div class="flex items-end gap-4">
        <button onclick="applyFilters()" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        <button onclick="resetFilters()" class="bg-gray-300 px-4 py-2 rounded-lg shadow-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500">‡∏•‡πâ‡∏≤‡∏á</button>
      </div>
    </div>

    <!-- Month and Update Status Filters -->
    <div class="flex flex-wrap gap-4 mb-6">
      <div class="w-auto">
        <label class="block text-sm font-semibold text-gray-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
        <select id="monthFilter" class="w-full border border-gray-300 rounded-lg px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="applyFilters()">
          <option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
        </select>
      </div>
      <div class="w-auto">
        <label class="block text-sm font-semibold text-gray-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</label>
        <select id="updateStatus" class="w-full border border-gray-300 rounded-lg px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="applyFilters()">
          <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
        </select>
      </div>
    </div>

    <!-- Loading Message -->
    <div id="loadingMessage" class="text-center text-gray-500 mb-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>

    <!-- Posts Table -->
    <div id="posts" class="overflow-x-auto">
      <label class="block text-sm font-semibold text-gray-700 mb-1 mr-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï <span id="postCount" class="text-blue-600 font-medium"></span></label>
      <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
        <tbody id="postsTableBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const $ = id => document.getElementById(id);
    const sheetURL = "https://docs.google.com/spreadsheets/d/1xRqnFHRWL3l_-6-LNJ_LM5Bejiv0aV5JwcV9PtzC-Nk/gviz/tq?tqx=out:json";
    const monthNames = ["", "‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
    let allPosts = [];

    const parseThaiDate = str => {
      const [d, m, y] = str.split('/');
      if (!d || !m || !y) return new Date("Invalid");
      const year = +y > 2500 ? +y - 543 : +y;
      return new Date(`${year}-${m}-${d}`);
    };

    const formatThaiDate = str => {
      const d = parseThaiDate(str);
      return isNaN(d) ? str : `${d.getDate()} ${monthNames[d.getMonth() + 1]} ${d.getFullYear() + 543}`;
    };

    const extractMonth = str => {
      const d = parseThaiDate(str);
      return isNaN(d) ? "" : `${d.getFullYear()}-${d.getMonth() + 1}`;
    };

    const getCurrentMonth = () => {
      const today = new Date();
      return `${today.getFullYear()}-${today.getMonth() + 1}`;
    };

    const fillDropdowns = () => {
      const months = [...new Set(allPosts
        .filter(p => p.detail && p.detail !== "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï")
        .map(p => p.month))].filter(Boolean).sort((a, b) => {
          const [yA, mA] = a.split("-").map(Number);
          const [yB, mB] = b.split("-").map(Number);
          return yA - yB || mA - mB;
      });

      $("monthFilter").innerHTML = `<option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>` + months.map(m => {
        const [y, mo] = m.split("-");
        return `<option value="${m}">${monthNames[+mo]} ${+y + 543}</option>`;
      }).join("");
    };

    const updateStatusDropdown = () => {
      const currentMonth = getCurrentMonth();
      const lastUpdate = allPosts.filter(p => p.month === currentMonth && p.detail && p.detail !== "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï").slice(0, 7);
      const hasUpdate = allPosts.filter(p => p.detail && p.detail !== "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï");
      const noUpdate = allPosts.filter(p => p.detail === "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï");

      $("updateStatus").innerHTML = `
        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
        <option value="lastUpdate">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
        <option value="hasUpdate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</option>
        <option value="noUpdate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</option>
      `;
    };

    const applyFilters = () => {
      const search = $("searchInput").value.toLowerCase();
      const start = $("startDate").value ? new Date($("startDate").value) : null;
      const end = $("endDate").value ? new Date($("endDate").value) : null;
      const month = $("monthFilter").value;
      const status = $("updateStatus").value;

      let filtered = allPosts.filter(p => {
        const date = parseThaiDate(p.date);
        const text = `${p.title} ${p.detail}`.toLowerCase();
        return (!search || text.includes(search)) &&
               (!start || date >= start) &&
               (!end || date <= end) &&
               (!month || p.month === month) &&
               p.detail && p.detail !== "";
      });

      if (status === "lastUpdate") {
        const currentMonth = getCurrentMonth();
        filtered = allPosts
          .filter(p => p.month === currentMonth && p.detail && p.detail !== "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï")
          .slice(0, 7);
      } else if (status === "hasUpdate") {
        filtered = filtered.filter(p => p.detail && p.detail !== "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï");
      } else if (status === "noUpdate") {
        filtered = filtered.filter(p => p.detail === "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï");
      }

      renderPosts(filtered);
    };

    const resetFilters = () => {
      $("searchInput").value = "";
      $("startDate").value = "";
      $("endDate").value = "";
      $("monthFilter").value = "";
      $("updateStatus").value = ""; 
      
      applyFilters();

      const currentMonth = getCurrentMonth();
      const filtered = allPosts.filter(p => p.month === currentMonth && p.detail && p.detail !== "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï");
      renderPosts(filtered);
    };
    
    const renderPosts = data => {
      const body = $("postsTableBody");
      $("postCount").textContent = `(${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;

      body.innerHTML = data.length
        ? data.map(p => `
            <tr class="border-b hover:bg-gray-50">
              <td class="px-6 py-3 text-sm">${formatThaiDate(p.date)}</td>
              <td class="px-6 py-3 text-sm font-semibold">${p.title || '‚Äî'}</td>
              <td class="px-6 py-3 text-sm text-gray-600">${p.detail?.replace(/\n/g, "<br>") || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}</td>
            </tr>`).join("")
        : `<tr><td colspan="3" class="text-center py-3 text-sm text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
    };

      fetch(sheetURL)
        .then(res => res.text())
        .then(text => {
          const json = JSON.parse(text.substring(47).slice(0, -2));
          allPosts = json.table.rows.map(row => {
            const date = row.c[0]?.f || row.c[0]?.v || "";
            return {
              date,
              title: row.c[1]?.v || "",
              detail: row.c[2]?.v || "",
              category: row.c[3]?.v || "",
              month: extractMonth(date),
              sortDate: parseThaiDate(date)
            };
          }).sort((a, b) => b.sortDate - a.sortDate);
      
          fillDropdowns();
          updateStatusDropdown();
          
          // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ default ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
          $("updateStatus").value = "";
          $("monthFilter").value = getCurrentMonth();
          applyFilters();
      
          $("loadingMessage").style.display = "none";
        });

  </script>
</body>
</html>
