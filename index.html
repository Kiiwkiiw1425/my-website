<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>üì¢ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800 p-4">

  <div class="max-w-4xl mx-auto">
    <h2 class="text-2xl font-bold mb-4">üì¢ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h2>

    <!-- Sorting Options -->
    <div class="flex gap-4 mb-4">
      <div>
        <label class="text-sm">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö</label>
        <select id="sortOrder" class="border px-2 py-1 rounded">
          <option value="desc">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô</option>
          <option value="asc">‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô</option>
        </select>
      </div>
    </div>

    <!-- Filters -->
    <div class="grid md:grid-cols-4 sm:grid-cols-2 gap-4 mb-6">
      <div>
        <label class="text-sm">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
        <input id="searchInput" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥..." class="w-full border px-2 py-1 rounded" />
      </div>
      <div>
        <label class="text-sm">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
        <input id="startDate" type="date" class="w-full border px-2 py-1 rounded" />
      </div>
      <div>
        <label class="text-sm">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
        <input id="endDate" type="date" class="w-full border px-2 py-1 rounded" />
      </div>
      <div class="flex items-end gap-2">
        <button onclick="applyFilters()" class="bg-blue-500 text-white px-3 py-1 rounded">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        <button onclick="resetFilters()" class="bg-gray-300 px-3 py-1 rounded">‡∏•‡πâ‡∏≤‡∏á</button>
      </div>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="mb-4"></div>

    <!-- Posts -->
    <div id="posts"></div>

    <!-- Export Buttons -->
    <div class="mt-4">
      <button onclick="exportToPDF()" class="bg-green-500 text-white px-4 py-2 rounded mr-4">Export PDF</button>
      <button onclick="exportToWord()" class="bg-blue-500 text-white px-4 py-2 rounded">Export Word</button>
    </div>
  </div>

  <script>
    const sheetURL = "https://docs.google.com/spreadsheets/d/1xRqnFHRWL3l_-6-LNJ_LM5Bejiv0aV5JwcV9PtzC-Nk/gviz/tq?tqx=out:json";
    let allPosts = [];
    let currentPage = 1;
    const postsPerPage = 5;

    const monthNames = ["", "‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];

    function parseThaiDate(dateStr) {
      const parts = dateStr.split('/');
      if (parts.length !== 3) return new Date("Invalid");
      let [day, month, year] = parts;
      year = parseInt(year) > 2500 ? parseInt(year) - 543 : year;
      return new Date(`${year}-${month}-${day}`);
    }

    function formatThaiDate(dateStr) {
      const date = parseThaiDate(dateStr);
      if (isNaN(date)) return dateStr;
      const day = date.getDate();
      const month = monthNames[date.getMonth() + 1];
      const year = date.getFullYear() + 543;
      return `${day} ${month} ${year}`;
    }

    function extractMonth(dateStr) {
      const date = parseThaiDate(dateStr);
      return `${date.getFullYear()}-${date.getMonth() + 1}`; // "2025-3"
    }

    function applyFilters() {
      const search = document.getElementById("searchInput").value.toLowerCase();
      const start = document.getElementById("startDate").value;
      const end = document.getElementById("endDate").value;
      const sortOrder = document.getElementById("sortOrder").value;

      let filtered = allPosts.filter(post => {
        const postDate = parseThaiDate(post.date);
        const content = `${post.title} ${post.detail}`.toLowerCase();

        let match = true;
        if (search && !content.includes(search)) match = false;
        if (start && postDate < new Date(start)) match = false;
        if (end && postDate > new Date(end)) match = false;

        return match;
      });

      if (sortOrder === "asc") {
        filtered = filtered.sort((a, b) => a.sortDate - b.sortDate);
      } else {
        filtered = filtered.sort((a, b) => b.sortDate - a.sortDate);
      }

      renderPosts(filtered);
    }

    function renderPosts(data) {
      const start = (currentPage - 1) * postsPerPage;
      const end = currentPage * postsPerPage;
      const pagePosts = data.slice(start, end);

      const container = document.getElementById("posts");
      container.innerHTML = pagePosts.length === 0 ? "<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>" : "";
      pagePosts.forEach(post => {
        const div = document.createElement("div");
        div.className = "bg-white border shadow-sm p-4 mb-4 rounded";
        div.innerHTML = `
          <div class="text-sm text-gray-500 mb-1">${formatThaiDate(post.date)}</div>
          <div class="font-bold text-lg mb-2">${post.title}</div>
          <div class="text-sm">${post.detail.replace(/\n/g, "<br>")}</div>
        `;
        container.appendChild(div);
      });

      renderPagination(data);
    }

    function renderPagination(data) {
      const totalPages = Math.ceil(data.length / postsPerPage);
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";

      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.className = `px-3 py-1 rounded ${i === currentPage ? "bg-blue-500 text-white" : "bg-gray-300"}`;
        btn.innerText = i;
        btn.onclick = () => {
          currentPage = i;
          renderPosts(data);
        };
        pagination.appendChild(btn);
      }
    }

    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const postsHTML = allPosts.map(post => `
        <h2>${post.title}</h2>
        <p>${post.detail}</p>
      `).join("\n");

      doc.text(postsHTML, 10, 10);
      doc.save("posts.pdf");
    }

    function exportToWord() {
      const postsHTML = allPosts.map(post => `
        <h2>${post.title}</h2>
        <p>${post.detail}</p>
      `).join("\n");

      const blob = new Blob([postsHTML], { type: "application/msword" });
      saveAs(blob, "posts.doc");
    }

    function fetchData() {
      fetch(sheetURL)
        .then(res => res.text())
        .then(text => {
          const json = JSON.parse(text.substr(47).slice(0, -2));
          const rows = json.table.rows;

          allPosts = rows.map(row => {
            const rawDate = row.c[0]?.f || row.c[0]?.v || '';
            const title = row.c[1]?.v || '';
            const detail = row.c[2]?.v || '';
            const category = row.c[3]?.v || '';
            return {
              date: rawDate,
              title,
              detail,
              category,
              month: extractMonth(rawDate),
              sortDate: parseThaiDate(rawDate)
            };
          });

          allPosts.sort((a, b) => b.sortDate - a.sortDate);
          applyFilters();
        });
    }

    fetchData();
  </script>

</body>
</html>
