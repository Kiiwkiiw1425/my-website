<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>รายการอัปเดตระบบ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .resizer {
      width: 5px;
      cursor: col-resize;
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      z-index: 10;
    }
    th {
      position: relative;
    }
  </style>
</head>
<body class="bg-gray-50 p-6">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-2xl font-bold text-gray-800 mb-6">ระบบติดตามสถานะการอัปเดต</h1>

    <div class="flex flex-wrap gap-4 mb-6">
      <div class="w-auto">
        <label class="block text-sm font-semibold text-gray-700 mb-1">เลือกเดือน</label>
        <select id="monthFilter" class="w-full border border-gray-300 rounded-lg px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="applyFilters()">
          <option value="">ทุกเดือน</option>
        </select>
      </div>
      <div class="w-auto">
        <label for="updateStatus" class="block text-sm font-semibold text-gray-700 mb-1">เลือกสถานะอัปเดต</label>
        <select id="updateStatus" class="w-full border border-gray-300 rounded-lg px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="applyFilters()">
          <option value="">ทุกวันที่มี/ไม่มีการอัปเดต</option>
          <option value="hasUpdate">วันที่มีการอัปเดต</option>
          <option value="noUpdate">วันที่ไม่มีการอัปเดต</option>
        </select>
      </div>
    </div>

    <div id="loadingMessage" class="text-center text-gray-500 mb-4">กำลังโหลดข้อมูล...</div>

    <div id="posts" class="overflow-x-auto">
      <div class="flex justify-between items-center mb-2">
        <label class="block text-sm font-semibold text-gray-700">รายการอัปเดต</label>
        <span id="updateCount" class="text-sm text-gray-600"></span>
      </div>
      <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
        <thead>
          <tr>
            <th class="resizable px-6 py-3 text-left text-sm font-medium text-gray-700 bg-gray-100" style="width:130px;">วันที่อัปเดต</th>
            <th class="resizable px-6 py-3 text-left text-sm font-medium text-gray-700 bg-gray-100" style="width:295px;">หัวข้อ</th>
            <th class="resizable px-6 py-3 text-left text-sm font-medium text-gray-700 bg-gray-100">รายละเอียด</th>
          </tr>
        </thead>
        <tbody id="postsTableBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const $ = id => document.getElementById(id);
    let allPosts = [];

    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTX1YBU6_XXXXXXX/pub?output=csv';

    function formatThaiDate(dateString) {
      const dt = luxon.DateTime.fromFormat(dateString, 'yyyy-MM-dd');
      return dt.setLocale('th').toFormat('d MMM yyyy');
    }

    function enableResizableColumns() {
      document.querySelectorAll('.resizer').forEach(r => r.remove());
      document.querySelectorAll('.resizable').forEach(th => {
        const resizer = document.createElement('div');
        resizer.classList.add('resizer');
        th.appendChild(resizer);
        let startX, startWidth;
        resizer.addEventListener('mousedown', e => {
          startX = e.clientX;
          startWidth = th.offsetWidth;
          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);
        });
        function onMouseMove(e) {
          const newWidth = startWidth + (e.clientX - startX);
          th.style.width = newWidth + 'px';
        }
        function onMouseUp() {
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUp);
        }
      });
    }

    function renderPosts(data) {
      const body = $("postsTableBody");
      const count = data.length;
      $("updateCount").textContent = `พบทั้งหมด ${count} รายการ`;
      body.innerHTML = count ? data.map(p => `
        <tr class="border-b hover:bg-gray-50">
          <td class="px-6 py-3 text-sm">${formatThaiDate(p.date)}</td>
          <td class="px-6 py-3 text-sm font-semibold">${p.title || '—'}</td>
          <td class="px-6 py-3 text-sm text-gray-600">${p.detail?.replace(/\n/g, "<br>") || 'ไม่มีการอัปเดต'}</td>
        </tr>`).join("") : `<tr><td colspan="3" class="text-center py-3 text-sm text-gray-500">ไม่พบข้อมูล</td></tr>`;
      enableResizableColumns();
    }

    function applyFilters() {
      const status = $("updateStatus").value;
      const month = $("monthFilter").value;
      let filtered = [...allPosts];

      if (status === 'hasUpdate') {
        filtered = filtered.filter(p => p.detail && p.detail.trim() !== '');
      } else if (status === 'noUpdate') {
        filtered = filtered.filter(p => !p.detail || p.detail.trim() === '');
      }

      if (month) {
        filtered = filtered.filter(p => luxon.DateTime.fromFormat(p.date, 'yyyy-MM-dd').toFormat('yyyy-MM') === month);
      }

      renderPosts(filtered);
    }

    function populateMonthFilter(data) {
      const months = new Set(data.map(p => luxon.DateTime.fromFormat(p.date, 'yyyy-MM-dd').toFormat('yyyy-MM')));
      months.forEach(m => {
        const option = document.createElement('option');
        option.value = m;
        option.textContent = luxon.DateTime.fromFormat(m, 'yyyy-MM').setLocale('th').toFormat('MMMM yyyy');
        $("monthFilter").appendChild(option);
      });
    }

    async function loadData() {
      try {
        const res = await axios.get(SHEET_URL);
        Papa.parse(res.data, {
          header: true,
          complete: results => {
            const data = results.data.map(r => ({
              date: r["วันที่อัปเดต"],
              title: r["หัวข้อ"],
              detail: r["รายละเอียด"]
            })).filter(p => p.date);
            allPosts = data;
            populateMonthFilter(data);
            renderPosts(data);
            $("loadingMessage").style.display = "none";
          }
        });
      } catch (err) {
        console.error("โหลดข้อมูลล้มเหลว", err);
      }
    }

    loadData();
  </script>
</body>
</html>
